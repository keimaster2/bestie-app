import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';

// .env.localから環境変数を読み込み (ローカル実行用)
dotenv.config({ path: '.env.local' });

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('Environment Check:');
console.log('- YAHOO_APP_ID:', process.env.YAHOO_APP_ID ? 'Available' : 'NOT FOUND');
console.log('- RAKUTEN_APP_ID:', process.env.RAKUTEN_APP_ID ? 'Available' : 'NOT FOUND');

// 基本設定
const CACHE_DIR = path.resolve(__dirname, '../src/data/cache');
const USER_AGENT = 'BestieApp/1.0 (Compatible; Mozilla/5.0)';

if (!fs.existsSync(CACHE_DIR)) {
    console.log('Creating Cache Directory:', CACHE_DIR);
    fs.mkdirSync(CACHE_DIR, { recursive: true });
}

// Yahoo API呼び出し
async function fetchYahoo(categoryId) {
    const appId = process.env.YAHOO_APP_ID;
    if (!appId) return [];
    const url = `https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch?appid=${appId}&genre_category_id=${categoryId}&sort=-sold&results=30`;

    try {
        const res = await fetch(url, { headers: { 'User-Agent': USER_AGENT } });
        if (!res.ok) {
            console.error(`  [Yahoo API Error] Status ${res.status} for category ${categoryId}`);
            return [];
        }
        const data = await res.json();
        return data.hits || [];
    } catch (e) {
        console.error(`  [Yahoo Fetch Error] Category ${categoryId}:`, e.message);
        return [];
    }
}

// 楽天 API呼び出し
async function fetchRakuten(genreId) {
    const appId = process.env.RAKUTEN_APP_ID;
    if (!appId) return [];
    const url = `https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628?applicationId=${appId}&genreId=${genreId}`;

    try {
        const res = await fetch(url);
        if (!res.ok) {
            console.error(`  [Rakuten API Error] Status ${res.status} for genre ${genreId}`);
            return [];
        }
        const data = await res.json();
        return data.Items || [];
    } catch (e) {
        console.error(`  [Rakuten Fetch Error] Genre ${genreId}:`, e.message);
        return [];
    }
}

async function sync() {
    console.log('Starting Ranking Sync...');

    const targets = [
        {
            brand: 'game',
            yahoo: ["2161", "77077", "50522", "50798", "50521"],
            rakuten: ["101205", "565989", "565990", "566236", "566237"]
        }
    ];

    for (const target of targets) {
        console.log(`Processing brand: ${target.brand}`);
        const brandDir = path.join(CACHE_DIR, target.brand);
        if (!fs.existsSync(brandDir)) fs.mkdirSync(brandDir, { recursive: true });

        // Yahoo Sync
        for (const id of target.yahoo) {
            console.log(`  Fetching Yahoo Category: ${id}`);
            const data = await fetchYahoo(id);
            fs.writeFileSync(path.join(brandDir, `yahoo-${id}.json`), JSON.stringify(data, null, 2));
            await new Promise(r => setTimeout(r, 1000));
        }

        // Rakuten Sync
        for (const id of target.rakuten) {
            console.log(`  Fetching Rakuten Genre: ${id}`);
            const data = await fetchRakuten(id);
            fs.writeFileSync(path.join(brandDir, `rakuten-${id}.json`), JSON.stringify(data, null, 2));
            await new Promise(r => setTimeout(r, 1000));
        }
    }

    // index.ts の自動生成
    console.log('Generating cache/index.ts...');
    let indexContent = '// This file is auto-generated by scripts/sync-rankings.mjs\n';
    indexContent += '// DO NOT EDIT MANUALLY\n\n';

    const cacheFiles = [];
    const brands = fs.readdirSync(CACHE_DIR).filter(f => fs.statSync(path.join(CACHE_DIR, f)).isDirectory());

    for (const brand of brands) {
        const brandDir = path.join(CACHE_DIR, brand);
        const files = fs.readdirSync(brandDir).filter(f => f.endsWith('.json'));
        for (const file of files) {
            const varName = `${brand}_${file.replace('.json', '').replace(/-/g, '_')}`;
            indexContent += `import ${varName} from './${brand}/${file}';\n`;
            cacheFiles.push({ key: `${brand}/${file.replace('.json', '')}`, varName });
        }
    }

    indexContent += '\nexport const RANKING_CACHE = {\n';
    for (const item of cacheFiles) {
        indexContent += `  '${item.key}': ${item.varName},\n`;
    }
    indexContent += '};\n';

    fs.writeFileSync(path.join(CACHE_DIR, 'index.ts'), indexContent);

    console.log('Sync Completed!');
}

sync().catch(err => {
    console.error('Fatal Sync Error:', err);
    process.exit(1);
});
